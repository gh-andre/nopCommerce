## branch `release-4.40.4-cmdline`

This branch contains source changes for building and publishing
NopCommerce from the command line or from within a CI pipeline,
such as Azure pipelines.

These changes work against NopCommerce source 4.30 and 4.40.4
and were not tested against any other released source packages.

NopCommerce can be published from Visual Studio, in which
case only the Nop.Web project is published. The same should
work from the command line, but it does only if `dotnet publish`
also builds the solution and if a separate `dotnet build`
command is used, publishing fails with some of the files
reported as not found, even though they do exist in the
output.

If you don't need build output generated in a separate step
(e.g. if you want to save PDB files for your plug-in, etc),
you can use `deploy.cmd` from the original source package
and avoid the steps and changes described in this file.

## Source package

These changes are intended for NopCommerce plug-in development
against a source package, *not* against the source repository
(e.g. source from `nopCommerce_4.40.4_Source.zip`).

This repository is used only to keep changes visible on GitHub
and a patch from this repository will not apply cleanly against
a source package because of inconsistent line endings between
files in the repository and same files in source packages.

When starting a NopCommerce plug-in development, you will need
NopCommerce source because the main application is not available
as a Nuget package, which would allow isolating plug-in source
from the main application.

### Delete build output and dependencies

Once you downloaded a source package, you will need to remove
build output and dependencies from the source tree before using
it to initialize your plug-in repository.

Delete `Build\ClearPluginAssemblies.dll`. This file is a build
output of the `Build\src\ClearPluginAssemblies\ClearPluginAssemblies.csproj`
and is disabled in this repository because it is unnecessary.

Delete all folders in `Presentation\Nop.Web\Plugins`, except
the one called `bin`. These folders contain dependencies and
build output generated by other projects. They account for
about 330 MB and should not be in the source repository.

There is a set of DLL files that is checked for SendinBlue
in `Plugins\Nop.Plugin.Misc.Sendinblue`. These DLLs are
necessary to build the solution, but as far as best practices
go, you may want to remove them as well, so your repository
contains only source files. If you do this, you will need a
separate script to download these files before NopCommerce
can be built locally or in a CI pipeline. For example, in
Azure pipelines, you can place them into a universal package
and download it as the initial step for local development
or in each build in a CI pipeline.

### Disable `ClearPluginAssemblies.proj`

This project deletes build output for plug-in projects and
a few additional files. Using this project has several
disadvantages described in comments in `ClearPluginAssemblies.proj`.
Apply the change from this repository to prevent this project
from running.

Note that in order to minimize the change, only the command
execution is commented out and other projects still include
this project.

### Avoid publishing for plug-in and test projects

Each affected project is changed to add `IsPublishable` to
their `.csproj` file, similar to this:

    <PropertyGroup>
      <IsPublishable>false</IsPublishable>
      <TargetFramework>net5.0</TargetFramework>
    ...

This setting tells .Net to avoid copying build output for
these projects when the project is being published. Without
this setting plug-in DLLs are copied twice - once on their
own and once via Nop.Web and the build output for the former
ends up in the top publish directory and prevents `Nop.Web.dll`
from running.

## Building NopCommerce from command line

All commands in this section are intended for the DOS command
prompt and need to be adjusted for PowerShell or Bash.

Before NopCommerce can be built, you need to restore Nuget
packages. This step is typically done transparently by
Visual Studio, but it must run every time in a CI pipeline.

    dotnet restore -p:Platform="Any CPU" NopCommerce.sln

This command builds the solution locally.

    dotnet build ^
          --no-restore ^
          --configuration Release ^
          -p:Platform="Any CPU" ^
          NopCommerce.sln

For a CI pipeline use `--output` to build in a dedicated
build directory. This allows incremental builds in pipelines
for self-hosted build agents that can preserve build output
between runs. Having build output in a separate directory
makes it easier to collect some files, such as PDBs, in
case if you need to debug your plug-in after the release,
or to remove some files before you publish them.

For example, for Azure pipelines, this command would look
like this:

    dotnet build ^
          --no-restore ^
          --configuration Release ^
          -p:Platform="Any CPU" ^
          --output "$(Build.BinariesDirectory)" ^
          NopCommerce.sln

This command publishes a local build output to an arbitrary
directory. If you want to publish .Net files as well, remove
`--no-self-contained`. Otherwise you will need to install
the corresponding .Net runtime on the target machine.

    dotnet publish ^
          --no-self-contained ^
          --no-build ^
          --configuration Release ^
          -p:Platform="Any CPU" ^
          --output c:\temp\NopCommerce\publish ^
          NopCommerce.sln

For a CI pipeline build output directory needs to be passed in
explicitly via MSBuild `OutDir` property. For example, for Azure
pipelines this command would look like this:

    dotnet publish ^
          --no-self-contained ^
          --no-build ^
          --configuration Release ^
          -p:Platform="Any CPU" ^
          -p:OutDir="$(Build.BinariesDirectory)" ^
          --output "$(Build.ArtifactStagingDirectory)/nopcommerce" ^
          NopCommerce.sln

In order to verify that the published output works, change
to the publish directory and run this command:

    dotnet Nop.Web.dll

You should not see any errors and the application should start
normally and report some informational messages.

## IIS environment

You will need to set up IIS in each CI environment, as described
in NopCommerce documentation and copy relevant application files
from the published package. The set of files you need to copy
will be different, depending on your application. For example,
for a plug-in development you may need to copy only your files,
but if you end up changing NopCommerce source, you will need to
copy all relevant files.

The deployment script from the source package uses Kudu Sync
to deploy published files. Check out `deploy.cmd` for details.

For the very first deployment, you will need to adjust folder
permissions in IIS root for a select set of folders. Use this
command as a template and adjust it as needed. Note that `%%d`
is intended for a batch file, which is what Azure pipelines
run, and if you want to run it from the command line, replace
it with `%d`.

    for %%d in (App_Data,Logs,Plugins,Plugins\bin,wwwroot\bundles,^
            wwwroot\db_backups,wwwroot\files\exportimport,^
            wwwroot\icons,wwwroot\images,wwwroot\images\thumbs,^
            wwwroot\images\uploaded
    ) do icacls "%%~d" /grant "IIS_IUSRS:(OI)(CI)(M)"

This command needs to be run for two users `IIS_IUSRS` and for
the user selected as the IIS worker pool user, which typically
starts with `IIS APPPOOL`.

Also, note that `wwwroot` above is not an IIS folder, but
rather one that is maintained by NopCommerce.

Once all this is done, browse the website where these files
were published and it will show an installer that will allow
you to set up NopCommerce database.
